<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storefront Next Cartridge</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: var(--vscode-font-family, system-ui, sans-serif);
        font-size: var(--vscode-font-size, 13px);
        color: var(--vscode-foreground);
        background: var(--vscode-editor-background);
        margin: 0;
        padding: 1.5rem;
      }
      h1 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 1.25rem;
      }
      .buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 20rem;
      }
      .buttons button {
        padding: 0.6rem 1rem;
        font-size: 1em;
        cursor: pointer;
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: none;
        border-radius: 4px;
        text-align: left;
      }
      .buttons button:hover {
        background: var(--vscode-button-hoverBackground);
      }
      .info {
        margin-top: 1.25rem;
        padding: 0.75rem;
        font-size: 0.9em;
        color: var(--vscode-descriptionForeground);
        background: var(--vscode-textBlockQuote-background);
        border-left: 4px solid var(--vscode-textBlockQuote-border);
        border-radius: 0 4px 4px 0;
      }
      .info h2 {
        font-size: 0.95em;
        margin: 0 0 0.5rem;
        color: var(--vscode-foreground);
      }
      .info ul {
        margin: 0.25rem 0 0 1rem;
        padding: 0;
      }
      .info code {
        font-size: 0.85em;
      }
      .info .status {
        margin: 0 0 0.5rem;
      }
      .info .status.error {
        color: var(--vscode-errorForeground);
      }
      .info .detail-rows {
        margin-top: 0.5rem;
      }
      .info .detail-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
        font-size: 0.9em;
      }
      .info .detail-label {
        flex: 0 0 7rem;
        color: var(--vscode-descriptionForeground);
      }
      .info .detail-value {
        word-break: break-all;
      }
      .info .error-detail {
        color: var(--vscode-errorForeground);
        margin: 0.25rem 0 0;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <h1>Storefront Next Cartridge</h1>
    <div class="buttons">
      <button type="button" id="create-cartridge-btn">Generate PageDesigner Metadata</button>
      <button type="button" id="deploy-cartridge-btn">Deploy Cartridge</button>
    </div>
    <div id="generated-section" class="info hidden">
      <h2>Generated metadata files</h2>
      <p id="generated-status" class="status"></p>
      <ul id="generated-files-list"></ul>
    </div>
    <div id="deploy-section" class="info hidden">
      <h2>Deploy result</h2>
      <p id="deploy-status" class="status"></p>
      <div id="deploy-details"></div>
    </div>
    <script>
      (function () {
        const vscode = acquireVsCodeApi();
        const generatedSection = document.getElementById('generated-section');
        const generatedStatus = document.getElementById('generated-status');
        const generatedList = document.getElementById('generated-files-list');
        const createBtn = document.getElementById('create-cartridge-btn');
        const deploySection = document.getElementById('deploy-section');
        const deployStatus = document.getElementById('deploy-status');
        const deployDetails = document.getElementById('deploy-details');
        const deployBtn = document.getElementById('deploy-cartridge-btn');

        function escapeHtml(s) {
          const div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        document.getElementById('create-cartridge-btn').addEventListener('click', function () {
          vscode.postMessage({type: 'createCartridge'});
        });
        document.getElementById('deploy-cartridge-btn').addEventListener('click', function () {
          vscode.postMessage({type: 'deployCartridge'});
        });

        window.addEventListener('message', function (event) {
          const msg = event.data;
          if (msg.type === 'createCartridgeResult') {
            generatedSection.classList.remove('hidden');
            if (msg.running) {
              generatedStatus.textContent = 'Running generate-cartridge…';
              generatedList.innerHTML = '';
              createBtn.disabled = true;
              return;
            }
            createBtn.disabled = false;
            if (msg.error) {
              generatedStatus.textContent = 'Error: ' + msg.error;
              generatedStatus.classList.add('error');
              generatedList.innerHTML = '';
              return;
            }
            generatedStatus.classList.remove('error');
            generatedStatus.textContent = msg.generatedFiles.length
              ? 'Generated ' + msg.generatedFiles.length + ' file(s):'
              : 'No .json metadata files found under cartridges/';
            generatedList.innerHTML = msg.generatedFiles
              .map(function (f) {
                return '<li><code>' + escapeHtml(f) + '</code></li>';
              })
              .join('');
            return;
          }
          if (msg.type === 'deployResult') {
            deploySection.classList.remove('hidden');
            if (msg.running) {
              deployStatus.textContent = 'Deploying cartridges…';
              deployStatus.classList.remove('error');
              deployDetails.innerHTML = '';
              deployBtn.disabled = true;
              return;
            }
            deployBtn.disabled = false;
            if (msg.error) {
              deployStatus.textContent = 'Deploy failed.';
              deployStatus.classList.add('error');
              deployDetails.innerHTML = '<p class="error-detail">' + escapeHtml(msg.error) + '</p>';
              return;
            }
            deployStatus.classList.remove('error');
            deployStatus.textContent = 'Deployed successfully.';
            var html = '<div class="detail-rows">';
            html +=
              '<div class="detail-row"><span class="detail-label">Hostname:</span><span class="detail-value">' +
              escapeHtml(msg.hostname || '—') +
              '</span></div>';
            html +=
              '<div class="detail-row"><span class="detail-label">Code version:</span><span class="detail-value">' +
              escapeHtml(msg.codeVersion || '—') +
              '</span></div>';
            html +=
              '<div class="detail-row"><span class="detail-label">Reloaded:</span><span class="detail-value">' +
              (msg.reloaded ? 'Yes' : 'No') +
              '</span></div>';
            html +=
              '<div class="detail-row"><span class="detail-label">Cartridges:</span><span class="detail-value">' +
              (msg.cartridges && msg.cartridges.length ? escapeHtml(msg.cartridges.join(', ')) : '—') +
              '</span></div>';
            html += '</div>';
            if (msg.cartridges && msg.cartridges.length > 0) {
              html += '<p style="margin-top: 0.5rem;">Count: ' + msg.cartridges.length + ' cartridge(s)</p>';
            }
            deployDetails.innerHTML = html;
          }
        });
      })();
    </script>
  </body>
</html>
